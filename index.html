<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thorax Swipe ‚Äî Serious Game (S2 M√©decine)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Helvetica','Arial','Apple Color Emoji','Segoe UI Emoji']
          }
        }
      }
    }
  </script>

  <style>
    /* ========= ‚ÄúTinder vibe‚Äù ========= */
    .deck {
      position: relative;
      width: min(92vw, 520px);
      height: 660px;
    }
    @media (max-width: 420px){
      .deck { height: 630px; }
    }

    .cardShadow {
      box-shadow:
        0 20px 60px rgba(0,0,0,.45),
        0 2px 10px rgba(0,0,0,.25);
    }

    .cardBase {
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      transform: translateZ(0);
    }

    .cardBack {
      position:absolute; inset:0;
      transform: scale(.98) translateY(10px);
      opacity: .55;
      filter: blur(.2px);
      pointer-events: none;
    }
    .cardBack2 {
      position:absolute; inset:0;
      transform: scale(.96) translateY(22px);
      opacity: .35;
      filter: blur(.6px);
      pointer-events: none;
    }

    .frontCard {
      position:absolute; inset:0;
      cursor: grab;
      user-select:none;
      touch-action: none;
      transition: box-shadow .2s ease, transform .18s ease;
    }
    .frontCard:active { cursor: grabbing; }

    /* Stamps LIKE / NOPE */
    .stamp {
      position:absolute;
      top: 18px;
      padding: 10px 14px;
      border-radius: 18px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      transform: rotate(-14deg);
      opacity: 0;
      pointer-events:none;
      transition: opacity .07s linear, transform .07s linear;
      backdrop-filter: blur(8px);
    }
    .stamp.show { opacity: 1; }

    /* Micro animations */
    .tap-pop { transition: transform .12s ease, filter .12s ease; }
    .tap-pop:active { transform: scale(.98); filter: brightness(1.07); }

    @keyframes swipeRight {
      0%   { transform: translateX(var(--dx,0px)) rotate(var(--rot,0deg)) scale(1); opacity: 1; }
      100% { transform: translateX(620px) rotate(18deg) scale(.98); opacity: 0; }
    }
    @keyframes swipeLeft {
      0%   { transform: translateX(var(--dx,0px)) rotate(var(--rot,0deg)) scale(1); opacity: 1; }
      100% { transform: translateX(-620px) rotate(-18deg) scale(.98); opacity: 0; }
    }
    .swipe-right { animation: swipeRight .36s ease forwards; }
    .swipe-left  { animation: swipeLeft  .36s ease forwards; }

    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
    }
    .shake { animation: shake .28s ease; }

    /* 3D media area: ‚Äúneon x-ray‚Äù frame */
    .mediaFrame {
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1200px 380px at 30% 0%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(800px 320px at 70% 20%, rgba(244,114,182,.18), transparent 55%),
        linear-gradient(to bottom, rgba(255,255,255,.07), rgba(255,255,255,.02));
    }

    .glowRing {
      box-shadow:
        0 0 0 1px rgba(255,255,255,.10) inset,
        0 10px 35px rgba(56,189,248,.12),
        0 10px 35px rgba(244,114,182,.10);
    }

    /* Modal */
    .modalHidden { display:none; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100 flex items-center justify-center p-4">
  <div id="app" class="w-full max-w-6xl">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-4">
      <div class="flex items-center gap-3">
        <div class="h-11 w-11 rounded-2xl bg-white/10 border border-white/10 shadow-lg grid place-items-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="opacity-90">
            <path d="M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 7c-2 2-2 8 0 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M17 7c2 2 2 8 0 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M5 10h14M5 14h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.65"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">Thorax Swipe</h1>
          <p class="text-sm text-slate-300">Anatomie du thorax ‚Ä¢ S2 M√©decine ‚Ä¢ Decisions rapides (LIKE / NOPE)</p>
          <p class="text-xs text-slate-400 mt-1">Encadrante : <b class="text-slate-200">PR. HAMRAOUI Salima</b></p>
        </div>
      </div>

      <div class="flex items-center gap-2 text-xs text-slate-300">
        <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10">‚Üê NOPE</span>
        <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10">‚Üí LIKE</span>
        <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10">45s / carte</span>
      </div>
    </header>

    <main class="bg-white/5 border border-white/10 rounded-3xl shadow-2xl backdrop-blur p-4 sm:p-6">

      <!-- START -->
      <section id="startScreen" class="p-2 sm:p-4">
        <div class="grid lg:grid-cols-2 gap-5 items-stretch">
          <div class="rounded-3xl bg-white/5 border border-white/10 p-5 sm:p-7 shadow-lg">
            <h2 class="text-lg font-semibold">Objectif p√©dagogique</h2>
            <p class="mt-2 text-slate-200 leading-relaxed">
              Acqu√©rir une vision globale et topographique du thorax :
              <b>d√©finition</b>, <b>r√¥les</b>, <b>dimensions</b>, <b>configuration ext√©rieure</b>.
            </p>

            <div class="mt-4 space-y-2 text-sm text-slate-300">
              <div class="flex gap-2">
                <span class="mt-1 inline-block h-2 w-2 rounded-full bg-emerald-400"></span>
                <p><b class="text-slate-100">UI Tinder</b> : une carte centrale, swipe LIKE/NOPE, feedback imm√©diat.</p>
              </div>
              <div class="flex gap-2">
                <span class="mt-1 inline-block h-2 w-2 rounded-full bg-sky-400"></span>
                <p><b class="text-slate-100">Stimulation 3D</b> : rendu ‚Äúneon x-ray‚Äù (sans images externes).</p>
              </div>
              <div class="flex gap-2">
                <span class="mt-1 inline-block h-2 w-2 rounded-full bg-amber-400"></span>
                <p><b class="text-slate-100">Timer</b> : 45 secondes par carte.</p>
              </div>
              <div class="flex gap-2">
                <span class="mt-1 inline-block h-2 w-2 rounded-full bg-fuchsia-400"></span>
                <p><b class="text-slate-100">Jauge de satisfaction</b> : monte si tu es juste, baisse si tu te trompes.</p>
              </div>
            </div>

            <button id="btnStart"
              class="mt-6 w-full tap-pop rounded-2xl bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold py-3 shadow-lg shadow-sky-500/20 border border-white/10 hover:brightness-110">
              D√©marrer le jeu
            </button>

            <p class="mt-3 text-xs text-slate-400">
              Astuce : <b class="text-slate-200">Swipe la carte</b> (glisser) ou utilise les boutons LIKE/NOPE.
            </p>

            <div class="mt-5 rounded-2xl bg-black/20 border border-white/10 p-4 text-xs text-slate-300">
              <p class="font-semibold text-slate-100">Prof</p>
              <p class="mt-1">PR. HAMRAOUI Salima</p>
            </div>
          </div>

          <div class="rounded-3xl bg-white/5 border border-white/10 p-5 sm:p-7 shadow-lg">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Aper√ßu ‚Äî Stimulation 3D (vibe ‚Äúneon thorax‚Äù)</h3>
              <button id="btnPreviewReset"
                class="tap-pop px-3 py-1.5 rounded-xl bg-white/5 border border-white/10 text-xs text-slate-200 hover:bg-white/10">
                Reset
              </button>
            </div>
            <p class="mt-2 text-sm text-slate-300">
              Mod√®le 3D ‚Äústyle radiographie n√©on‚Äù (c√¥tes + sternum + poumons + m√©diastin, rendu glow).
              Drag pour tourner ici (preview).
            </p>

            <div class="mt-4 mediaFrame glowRing">
              <div class="aspect-[4/3]">
                <canvas id="thoraxCanvasPreview" class="w-full h-full block"></canvas>
                <div id="noWebGLPreview" class="hidden w-full h-full grid place-items-center p-6 text-center text-slate-300">
                  <div>
                    <p class="font-semibold text-slate-100">WebGL indisponible</p>
                    <p class="text-sm mt-1">Le 3D ne s‚Äôaffiche pas ici. Le jeu reste jouable.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4 grid sm:grid-cols-3 gap-2 text-xs text-slate-300">
              <div class="rounded-2xl bg-white/5 border border-white/10 p-3">
                <p class="text-slate-100 font-semibold">Glow</p>
                <p class="mt-1">Effet ‚Äúbloom‚Äù pour le style.</p>
              </div>
              <div class="rounded-2xl bg-white/5 border border-white/10 p-3">
                <p class="text-slate-100 font-semibold">Focus auto</p>
                <p class="mt-1">Chaque carte surligne une zone.</p>
              </div>
              <div class="rounded-2xl bg-white/5 border border-white/10 p-3">
                <p class="text-slate-100 font-semibold">Confettis</p>
                <p class="mt-1">Si bon score : üéâ</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- GAME -->
      <section id="gameScreen" class="hidden">
        <!-- HUD -->
        <div class="grid lg:grid-cols-3 gap-3 mb-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="flex items-center justify-between">
              <p class="text-sm text-slate-300">Progression</p>
              <p class="text-sm font-semibold"><span id="qIndex">1</span>/<span id="qTotal">20</span></p>
            </div>
            <div class="mt-3 h-2 rounded-full bg-white/10 overflow-hidden">
              <div id="progressBar" class="h-full rounded-full bg-gradient-to-r from-emerald-400 to-sky-400 w-0 transition-[width] duration-200"></div>
            </div>
            <p class="mt-2 text-xs text-slate-400">20 cartes ‚Äî swipe pour avancer.</p>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="flex items-center justify-between">
              <p class="text-sm text-slate-300">Timer</p>
              <p class="text-sm font-semibold"><span id="timeText">45</span>s</p>
            </div>
            <div class="mt-3 h-2 rounded-full bg-white/10 overflow-hidden">
              <div id="timeBar" class="h-full rounded-full bg-gradient-to-r from-amber-400 to-rose-400 w-full transition-[width] duration-200"></div>
            </div>
            <p class="mt-2 text-xs text-slate-400">0s = r√©ponse incorrecte.</p>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="flex items-center justify-between">
              <p class="text-sm text-slate-300">Satisfaction</p>
              <p class="text-sm font-semibold"><span id="satisfactionText">50</span>%</p>
            </div>
            <div class="mt-3 h-2 rounded-full bg-white/10 overflow-hidden">
              <div id="satisfactionBar" class="h-full rounded-full bg-gradient-to-r from-indigo-400 to-fuchsia-400 w-[50%] transition-[width] duration-200"></div>
            </div>
            <p class="mt-2 text-xs text-slate-400">Monde ‚Äúflow‚Äù ‚ÜóÔ∏é si tu es juste.</p>
          </div>
        </div>

        <!-- Tinder deck -->
        <div class="flex flex-col items-center gap-4">
          <div class="deck">
            <!-- Back cards (visual stack) -->
            <div class="cardBack cardBase cardShadow bg-gradient-to-b from-white/8 to-white/4"></div>
            <div class="cardBack2 cardBase cardShadow bg-gradient-to-b from-white/7 to-white/3"></div>

            <!-- Stamps -->
            <div id="stampNope"
              class="stamp left-6 bg-rose-500/15 border-2 border-rose-400/60 text-rose-100">
              NOPE
            </div>
            <div id="stampLike"
              class="stamp right-6 bg-emerald-500/15 border-2 border-emerald-400/60 text-emerald-100"
              style="transform: rotate(14deg);">
              LIKE
            </div>

            <!-- Front card -->
            <article id="card"
              class="frontCard cardBase cardShadow bg-gradient-to-b from-white/10 to-white/5 p-4 sm:p-5">
              <!-- Media (3D) -->
              <div class="mediaFrame glowRing">
                <div class="aspect-[4/3] relative">
                  <canvas id="thoraxCanvasCard" class="w-full h-full block"></canvas>
                  <div id="noWebGLCard" class="hidden w-full h-full absolute inset-0 grid place-items-center p-6 text-center text-slate-300">
                    <div>
                      <p class="font-semibold text-slate-100">WebGL indisponible</p>
                      <p class="text-sm mt-1">Le 3D ne s‚Äôaffiche pas ici. Le jeu reste jouable.</p>
                    </div>
                  </div>

                  <!-- Overlay top bar -->
                  <div class="absolute inset-x-0 top-0 p-3 flex items-center justify-between pointer-events-none">
                    <div class="pointer-events-auto flex gap-2">
                      <span id="tagFocus"
                        class="px-3 py-1 rounded-full bg-black/30 border border-white/10 text-xs text-slate-200">
                        Focus : ‚Äî
                      </span>
                    </div>

                    <div class="pointer-events-auto flex items-center gap-2">
                      <span class="px-3 py-1 rounded-full bg-black/30 border border-white/10 text-xs text-slate-200">
                        Score : <b id="scoreText">0</b>/20
                      </span>
                      <button id="btnInspect3D"
                        class="tap-pop px-3 py-1 rounded-full bg-black/30 border border-white/10 text-xs text-slate-200 hover:bg-black/40">
                        Inspecter 3D
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Statement -->
              <div class="mt-4">
                <p class="text-xs text-slate-300">Situation / affirmation</p>
                <h2 id="statement" class="mt-2 text-lg sm:text-xl font-semibold leading-snug">
                  ‚Äî
                </h2>

                <!-- Feedback -->
                <div id="feedback" class="hidden mt-4 rounded-2xl border border-white/10 bg-black/25 p-4">
                  <div class="flex items-start gap-3">
                    <div id="feedbackDot" class="mt-1 h-3 w-3 rounded-full bg-slate-400"></div>
                    <div>
                      <p id="feedbackTitle" class="font-semibold">‚Äî</p>
                      <p id="feedbackText" class="mt-1 text-sm text-slate-200 leading-relaxed">‚Äî</p>
                    </div>
                  </div>
                </div>

                <div class="mt-4 flex flex-wrap gap-2 text-xs text-slate-300">
                  <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10">Swipe = Tinder</span>
                  <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10">‚Üê / ‚Üí</span>
                  <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10">PR. HAMRAOUI Salima</span>
                </div>
              </div>
            </article>
          </div>

          <!-- Controls -->
          <div class="w-full max-w-[520px] grid grid-cols-2 gap-3">
            <button id="btnNope"
              class="tap-pop rounded-2xl bg-white/5 border border-white/10 py-3 shadow-lg hover:bg-white/10 flex items-center justify-center gap-2">
              <span class="inline-flex h-10 w-10 rounded-2xl bg-rose-500/15 border border-rose-400/20 items-center justify-center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-rose-200">
                  <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
              </span>
              <div class="text-left">
                <p class="font-semibold">NOPE</p>
                <p class="text-xs text-slate-300 -mt-0.5">Rejeter</p>
              </div>
            </button>

            <button id="btnLike"
              class="tap-pop rounded-2xl bg-gradient-to-r from-emerald-500/90 to-sky-500/90 border border-white/10 py-3 shadow-lg shadow-emerald-500/10 hover:brightness-110 flex items-center justify-center gap-2">
              <div class="text-right">
                <p class="font-semibold">LIKE</p>
                <p class="text-xs text-white/80 -mt-0.5">Valider</p>
              </div>
              <span class="inline-flex h-10 w-10 rounded-2xl bg-white/15 border border-white/20 items-center justify-center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-white">
                  <path d="M12 21s-7-4.4-9.5-8.5C.4 9.4 2.4 6 6 6c2 0 3.3 1 4 2 0.7-1 2-2 4-2 3.6 0 5.6 3.4 3.5 6.5C19 16.6 12 21 12 21z"
                        stroke="currentColor" stroke-width="2" fill="none" stroke-linejoin="round"/>
                </svg>
              </span>
            </button>
          </div>

          <p class="text-xs text-slate-400 text-center">
            Raccourcis : <b class="text-slate-200">‚Üê</b> NOPE ‚Ä¢ <b class="text-slate-200">‚Üí</b> LIKE ‚Ä¢ <b class="text-slate-200">I</b> Inspecter 3D
          </p>
        </div>
      </section>

      <!-- END -->
      <section id="endScreen" class="hidden p-2 sm:p-4">
        <div class="rounded-3xl bg-white/5 border border-white/10 p-6 sm:p-8 shadow-xl text-center">
          <p class="text-sm text-slate-300">R√©sultat</p>
          <h2 class="mt-2 text-2xl sm:text-3xl font-semibold">Fin de partie</h2>

          <div class="mt-5 grid sm:grid-cols-3 gap-3">
            <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
              <p class="text-xs text-slate-300">Score</p>
              <p class="mt-1 text-xl font-semibold"><span id="finalScore">0</span>/20</p>
            </div>
            <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
              <p class="text-xs text-slate-300">Mention</p>
              <p class="mt-1 text-xl font-semibold" id="finalMention">‚Äî</p>
            </div>
            <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
              <p class="text-xs text-slate-300">Satisfaction</p>
              <p class="mt-1 text-xl font-semibold"><span id="finalSatisfaction">0</span>%</p>
            </div>
          </div>

          <p id="finalTip" class="mt-5 text-sm text-slate-200 leading-relaxed">‚Äî</p>

          <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
            <button id="btnRestart"
              class="tap-pop rounded-2xl bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold py-3 px-6 shadow-lg shadow-sky-500/20 border border-white/10 hover:brightness-110">
              Rejouer
            </button>
            <button id="btnBackToStart"
              class="tap-pop rounded-2xl bg-white/5 border border-white/10 py-3 px-6 hover:bg-white/10">
              Retour √† l‚Äôaccueil
            </button>
          </div>

          <p class="mt-4 text-xs text-slate-400">
            Encadrante : <b class="text-slate-200">PR. HAMRAOUI Salima</b>
          </p>
        </div>
      </section>

    </main>

    <footer class="mt-4 text-center text-xs text-slate-500">
      Single-file ‚Ä¢ Tailwind ‚Ä¢ Vanilla JS ‚Ä¢ 3D Three.js (neon glow) ‚Ä¢ Confettis (canvas-confetti)
    </footer>
  </div>

  <!-- Modal 3D Inspect -->
  <div id="inspectModal" class="modalHidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
    <div class="relative h-full w-full grid place-items-center p-4">
      <div class="w-full max-w-4xl rounded-3xl bg-slate-950/70 border border-white/10 shadow-2xl overflow-hidden">
        <div class="p-4 flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold">Inspection 3D ‚Äî Thorax</p>
            <p class="text-xs text-slate-300">Drag pour tourner ‚Ä¢ Molette pour zoom ‚Ä¢ Focus auto selon la carte</p>
          </div>
          <div class="flex gap-2">
            <button id="btnInspectReset" class="tap-pop px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-sm hover:bg-white/10">
              Reset
            </button>
            <button id="btnInspectClose" class="tap-pop px-3 py-2 rounded-xl bg-rose-500/15 border border-rose-400/25 text-sm hover:bg-rose-500/20">
              Fermer
            </button>
          </div>
        </div>
        <div class="p-4 pt-0">
          <div class="mediaFrame glowRing">
            <div class="aspect-[16/10]">
              <canvas id="thoraxCanvasInspect" class="w-full h-full block"></canvas>
              <div id="noWebGLInspect" class="hidden w-full h-full grid place-items-center p-6 text-center text-slate-300">
                <div>
                  <p class="font-semibold text-slate-100">WebGL indisponible</p>
                  <p class="text-sm mt-1">Impossible d‚Äôouvrir l‚Äôinspection 3D sur cet appareil.</p>
                </div>
              </div>
            </div>
          </div>
          <p class="mt-3 text-xs text-slate-400">
            Astuce : observe le rep√®re global (cage thoracique) puis la zone surlign√©e (sternum / c√¥tes / diaphragme / m√©diastin‚Ä¶).
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs (CDN) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <script>
    (() => {
      "use strict";

      // =========================
      // 1) DATA (easy to edit)
      // =========================
      const QUESTIONS = [
        { id: 1,  statement: "¬´ Le thorax est la r√©gion du tronc entre le cou et l‚Äôabdomen ; sa limite inf√©rieure fonctionnelle est le diaphragme. ¬ª", correct: true,  explain: "‚úÖ Oui. Thorax = entre cou et abdomen. La base est ferm√©e fonctionnellement par le diaphragme (ouverture inf√©rieure).", focus: "global" },
        { id: 2,  statement: "¬´ Le r√¥le principal du thorax est uniquement digestif. ¬ª", correct: false, explain: "‚ùå Non. Thorax = surtout respiration + protection (c≈ìur, poumons, gros vaisseaux) + m√©canique ventilatoire.", focus: "global" },
        { id: 3,  statement: "¬´ La cage thoracique prot√®ge le c≈ìur, les poumons et les gros vaisseaux. ¬ª", correct: true,  explain: "‚úÖ Exact. Protection des organes thoraciques = fonction majeure.", focus: "ribs" },
        { id: 4,  statement: "¬´ Le thorax participe √† la respiration via les mouvements des c√¥tes et du sternum. ¬ª", correct: true,  explain: "‚úÖ Oui. Les mouvements costaux/sternaux augmentent les diam√®tres thoraciques √† l‚Äôinspiration.", focus: "ribs" },
        { id: 5,  statement: "¬´ Le thorax ne contient aucune structure musculaire importante. ¬ª", correct: false, explain: "‚ùå Faux. Intercostaux, diaphragme, muscles accessoires‚Ä¶ essentiels √† la respiration.", focus: "wall" },
        { id: 6,  statement: "¬´ On compte classiquement 12 paires de c√¥tes chez l‚Äôadulte. ¬ª", correct: true,  explain: "‚úÖ Oui (variations rares).", focus: "ribs" },
        { id: 7,  statement: "¬´ Les c√¥tes 1 √† 7 sont dites flottantes. ¬ª", correct: false, explain: "‚ùå Non. 1‚Äì7 = vraies ; 8‚Äì10 = fausses ; 11‚Äì12 = flottantes.", focus: "ribs" },
        { id: 8,  statement: "¬´ Le sternum = manubrium + corps + processus xipho√Øde. ¬ª", correct: true,  explain: "‚úÖ Exact. Rep√®re m√©dian ant√©rieur essentiel.", focus: "sternum" },
        { id: 9,  statement: "¬´ Ouverture sup√©rieure : T1 en arri√®re, 1√®re c√¥te de chaque c√¥t√©, bord sup du manubrium en avant. ¬ª", correct: true, explain: "‚úÖ Oui. Rep√®re cl√© du d√©fil√© cervico-thoracique.", focus: "apertureSuperior" },
        { id: 10, statement: "¬´ L‚Äôouverture inf√©rieure du thorax est largement obtur√©e par le diaphragme. ¬ª", correct: true,  explain: "‚úÖ Oui. Cadre osseux + fermeture fonctionnelle par le diaphragme.", focus: "diaphragm" },
        { id: 11, statement: "¬´ En coupe, le thorax est parfaitement circulaire chez l‚Äôadulte. ¬ª", correct: false, explain: "‚ùå Non. La forme est plut√¥t ovale/elliptique.", focus: "dimensions" },
        { id: 12, statement: "¬´ Le diam√®tre transverse du thorax est souvent sup√©rieur au diam√®tre ant√©ro-post√©rieur. ¬ª", correct: true,  explain: "‚úÖ Oui, id√©e simple utile pour la vision globale.", focus: "dimensions" },
        { id: 13, statement: "¬´ La ligne m√©dio-claviculaire est un rep√®re de surface utile en topographie. ¬ª", correct: true,  explain: "‚úÖ Oui. Les lignes de rep√®re aident √† localiser les structures.", focus: "surface" },
        { id: 14, statement: "¬´ Le mamelon est un rep√®re fiable pour compter les espaces intercostaux chez tous. ¬ª", correct: false, explain: "‚ùå Faux. Rep√®re variable ; pr√©f√©rer angle sternal / c√¥tes.", focus: "surface" },
        { id: 15, statement: "¬´ Les espaces intercostaux sont num√©rot√©s d‚Äôapr√®s la c√¥te situ√©e au-dessus. ¬ª", correct: true,  explain: "‚úÖ Exact (EIC4 sous la 4e c√¥te).", focus: "wall" },
        { id: 16, statement: "¬´ Configuration ext√©rieure : rep√®res palpables (clavicule, angle sternal, arc costal‚Ä¶). ¬ª", correct: true,  explain: "‚úÖ Oui. Indispensable pour clinique + topographie.", focus: "surface" },
        { id: 17, statement: "¬´ Le diaphragme s‚Äôins√®re uniquement sur le sternum, sans lien avec les c√¥tes. ¬ª", correct: false, explain: "‚ùå Faux. Insertions sternales + costales + vert√©brales (pili).", focus: "diaphragm" },
        { id: 18, statement: "¬´ Le m√©diastin est l‚Äôespace central entre les deux cavit√©s pleurales. ¬ª", correct: true,  explain: "‚úÖ Oui (c≈ìur, gros vaisseaux, trach√©e, ≈ìsophage‚Ä¶).", focus: "mediastinum" },
        { id: 19, statement: "¬´ La paroi thoracique = peau, fascia, muscles + squelette (c√¥tes, sternum, vert√®bres). ¬ª", correct: true, explain: "‚úÖ Exact. Base d‚Äôune vision topographique globale.", focus: "wall" },
        { id: 20, statement: "¬´ √Ä l‚Äôinspiration, le diam√®tre ant√©ro-post√©rieur du thorax diminue. ¬ª", correct: false, explain: "‚ùå Non. √Ä l‚Äôinspiration, les diam√®tres augmentent (AP + transverse).", focus: "dimensions" }
      ];

      // =========================
      // 2) DOM refs
      // =========================
      const $ = (id) => document.getElementById(id);

      const startScreen = $("startScreen");
      const gameScreen  = $("gameScreen");
      const endScreen   = $("endScreen");

      const btnStart = $("btnStart");
      const btnRestart = $("btnRestart");
      const btnBackToStart = $("btnBackToStart");

      const card = $("card");
      const statementEl = $("statement");
      const feedback = $("feedback");
      const feedbackDot = $("feedbackDot");
      const feedbackTitle = $("feedbackTitle");
      const feedbackText = $("feedbackText");

      const btnNope = $("btnNope");
      const btnLike = $("btnLike");

      const qIndexEl = $("qIndex");
      const qTotalEl = $("qTotal");
      const progressBar = $("progressBar");

      const timeText = $("timeText");
      const timeBar = $("timeBar");

      const satisfactionText = $("satisfactionText");
      const satisfactionBar = $("satisfactionBar");

      const scoreText = $("scoreText");
      const tagFocus = $("tagFocus");

      const finalScore = $("finalScore");
      const finalMention = $("finalMention");
      const finalSatisfaction = $("finalSatisfaction");
      const finalTip = $("finalTip");

      const stampNope = $("stampNope");
      const stampLike = $("stampLike");

      // 3D
      const canvasPreview = $("thoraxCanvasPreview");
      const canvasCard    = $("thoraxCanvasCard");
      const canvasInspect = $("thoraxCanvasInspect");

      const noWebGLPreview = $("noWebGLPreview");
      const noWebGLCard = $("noWebGLCard");
      const noWebGLInspect = $("noWebGLInspect");

      const btnPreviewReset = $("btnPreviewReset");
      const btnInspect3D = $("btnInspect3D");

      const inspectModal = $("inspectModal");
      const btnInspectClose = $("btnInspectClose");
      const btnInspectReset = $("btnInspectReset");

      // =========================
      // 3) State
      // =========================
      const state = {
        questions: [],
        index: 0,
        score: 0,
        satisfaction: 50,
        locked: false,
        timerId: null,
        deadline: 0,
        timeTotalMs: 45000,
        currentFocus: "global",
        inspectOpen: false
      };

      // =========================
      // 4) Utils
      // =========================
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

      function setVisible(el, isVisible) { el.classList.toggle("hidden", !isVisible); }
      function setStamp(which, show) {
        if (which === "nope") stampNope.classList.toggle("show", show);
        if (which === "like") stampLike.classList.toggle("show", show);
      }

      function focusLabel(focusKey) {
        const map = {
          global: "Vue globale",
          ribs: "C√¥tes / cage thoracique",
          sternum: "Sternum",
          diaphragm: "Diaphragme",
          apertureSuperior: "Ouverture sup.",
          dimensions: "Dimensions",
          surface: "Rep√®res surface",
          mediastinum: "M√©diastin",
          wall: "Paroi thoracique"
        };
        return map[focusKey] || "‚Äî";
      }

      function mentionFromScore(score) {
        if (score >= 18) return { label: "BRAVO üéâ", tip: "Excellent. Tu as une vision globale + des rep√®res topographiques solides. Continue avec rep√®res palpables (angle sternal, arcs costaux‚Ä¶)." };
        if (score >= 14) return { label: "TR√àS BIEN ‚úÖ", tip: "Tr√®s bon niveau. Pour progresser : justifie chaque rep√®re (ouvertures, types de c√¥tes, diam√®tres)." };
        if (score >= 10) return { label: "ASSEZ BIEN üëç", tip: "Bon d√©part. Revois types de c√¥tes, sternum, diaphragme, rep√®res externes, dimensions." };
        return { label: "√Ä REVOIR üîÅ", tip: "Reprends : d√©finition ‚Üí r√¥les ‚Üí rep√®res ‚Üí dimensions. Ensuite, refais le jeu en expliquant √† voix haute." };
      }

      function safeConfettiBurst() {
        if (typeof window.confetti !== "function") return;
        const end = Date.now() + 1100;
        (function frame() {
          window.confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
          window.confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
          if (Date.now() < end) requestAnimationFrame(frame);
        })();
      }

      // =========================
      // 5) Timer
      // =========================
      function stopTimer() {
        if (state.timerId) { clearInterval(state.timerId); state.timerId = null; }
      }

      function startTimer() {
        stopTimer();
        state.deadline = Date.now() + state.timeTotalMs;

        const tick = () => {
          const msLeft = state.deadline - Date.now();
          const clamped = Math.max(0, msLeft);
          const seconds = Math.ceil(clamped / 1000);

          timeText.textContent = String(seconds);
          timeBar.style.width = `${(clamped / state.timeTotalMs) * 100}%`;

          if (msLeft <= 0) {
            stopTimer();
            handleTimeout();
          }
        };

        tick();
        state.timerId = setInterval(tick, 200);
      }

      function handleTimeout() {
        if (state.locked) return;
        handleChoice(false, true); // timeout = incorrect => NOPE
      }

      // =========================
      // 6) HUD / Feedback
      // =========================
      function showFeedback(isCorrect, text, isTimeout) {
        setVisible(feedback, true);
        if (isCorrect) {
          feedbackDot.className = "mt-1 h-3 w-3 rounded-full bg-emerald-400";
          feedbackTitle.textContent = "Correct ‚úÖ";
          feedbackText.textContent = text;
        } else {
          feedbackDot.className = "mt-1 h-3 w-3 rounded-full bg-rose-400";
          feedbackTitle.textContent = isTimeout ? "Temps √©coul√© ‚è±Ô∏è" : "Incorrect ‚ùå";
          feedbackText.textContent = text;
        }
      }
      function hideFeedback() { setVisible(feedback, false); }

      function updateHUD() {
        qTotalEl.textContent = String(state.questions.length);
        qIndexEl.textContent = String(state.index + 1);
        scoreText.textContent = String(state.score);

        const progress = ((state.index) / state.questions.length) * 100;
        progressBar.style.width = `${progress}%`;

        satisfactionText.textContent = String(state.satisfaction);
        satisfactionBar.style.width = `${state.satisfaction}%`;
      }

      function setLocked(v) { state.locked = v; }

      // =========================
      // 7) ‚ÄúNeon Thorax‚Äù 3D (procedural, no external models)
      // =========================
      function createNeonThorax3D(canvasEl, noWebGLEl, { interactive }) {
        try {
          if (!window.THREE || !canvasEl) throw new Error("THREE missing");
          const THREE = window.THREE;

          // Renderer
          let renderer;
          try {
            renderer = new THREE.WebGLRenderer({ canvas: canvasEl, alpha: true, antialias: true, powerPreference: "high-performance" });
          } catch (e) {
            if (noWebGLEl) noWebGLEl.classList.remove("hidden");
            return null;
          }
          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
          renderer.setClearColor(0x000000, 0);
          if (renderer.outputColorSpace !== undefined) renderer.outputColorSpace = THREE.SRGBColorSpace;

          // Scene & camera
          const scene = new THREE.Scene();
          const camera = new THREE.PerspectiveCamera(42, 1, 0.1, 200);
          camera.position.set(0, 2.8, 16);

          // Lights
          scene.add(new THREE.HemisphereLight(0xffffff, 0x0b1020, 0.95));
          const key = new THREE.DirectionalLight(0xffffff, 0.85);
          key.position.set(6, 10, 8);
          scene.add(key);
          const rim = new THREE.DirectionalLight(0xffd1f0, 0.35);
          rim.position.set(-10, 2, -8);
          scene.add(rim);

          // Postprocessing bloom (if available)
          let composer = null;
          const canBloom = !!(THREE.EffectComposer && THREE.RenderPass && THREE.UnrealBloomPass);
          if (canBloom) {
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(new THREE.RenderPass(scene, camera));
            const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(1,1), 1.15, 0.55, 0.22);
            composer.addPass(bloom);
          }

          // Root
          const root = new THREE.Group();
          scene.add(root);

          // Materials (neon / x-ray vibe)
          const matBone = new THREE.MeshStandardMaterial({ color: 0x79D9FF, roughness: 0.35, metalness: 0.08, emissive: 0x0b1b2e, emissiveIntensity: 0.35 });
          const matBone2 = new THREE.MeshStandardMaterial({ color: 0xBFEAFF, roughness: 0.45, metalness: 0.05, emissive: 0x0b1b2e, emissiveIntensity: 0.25 });

          const matLung = new THREE.MeshPhysicalMaterial({
            color: 0xFF5AAE,
            roughness: 0.2,
            metalness: 0.0,
            transmission: 0.85,
            thickness: 2.2,
            ior: 1.35,
            transparent: true,
            opacity: 0.72,
            emissive: 0x3a001c,
            emissiveIntensity: 0.55
          });

          const matMedi = new THREE.MeshPhysicalMaterial({
            color: 0xA78BFA,
            roughness: 0.3,
            metalness: 0.0,
            transmission: 0.75,
            thickness: 1.8,
            ior: 1.35,
            transparent: true,
            opacity: 0.25,
            emissive: 0x1a083a,
            emissiveIntensity: 0.7
          });

          const matLine = new THREE.LineBasicMaterial({ color: 0xFFD1EC, transparent: true, opacity: 0.9 });

          // Groups for focus
          const groups = {
            ribs: new THREE.Group(),
            sternum: new THREE.Group(),
            diaphragm: new THREE.Group(),
            apertureSuperior: new THREE.Group(),
            mediastinum: new THREE.Group(),
            wall: new THREE.Group(),
            dimensions: new THREE.Group(),
            surface: new THREE.Group(),
            global: new THREE.Group()
          };

          // Build ribs with curves (more ‚Äúrealistic‚Äù than torus)
          function ribCurve(sideSign, level) {
            // sideSign: -1 left, +1 right
            // level: 0..11 (1..12 ribs)
            const y = 4.3 - level * 0.55;
            const width = 4.9 + level * 0.35;
            const depth = 3.6 + level * 0.2;

            // rib shape from spine (posterior) to sternum (anterior)
            const p0 = new THREE.Vector3(0.5 * sideSign, y, -3.1);              // posterior near spine
            const p1 = new THREE.Vector3(2.2 * sideSign, y + 0.2, -2.0);       // posterolateral
            const p2 = new THREE.Vector3((width) * sideSign, y + 0.15, 0.2);   // lateral
            const p3 = new THREE.Vector3((width-0.8) * sideSign, y - 0.1, depth); // anterolateral
            const p4 = new THREE.Vector3(1.2 * sideSign, y - 0.25, 3.15);      // anterior near sternum

            const curve = new THREE.CatmullRomCurve3([p0, p1, p2, p3, p4], false, "catmullrom", 0.6);
            return curve;
          }

          const ribCount = 12;
          for (let i = 0; i < ribCount; i++) {
            const radius = 0.12 + (i * 0.002);
            const segments = 120;

            const left = new THREE.Mesh(new THREE.TubeGeometry(ribCurve(-1, i), segments, radius, 10, false), matBone);
            const right = new THREE.Mesh(new THREE.TubeGeometry(ribCurve(+1, i), segments, radius, 10, false), matBone);

            groups.ribs.add(left, right);
          }

          // Sternum (manubrium + body + xiphoid)
          const sternumBody = new THREE.Mesh(new THREE.CylinderGeometry(0.55, 0.7, 5.2, 18), matBone2);
          sternumBody.position.set(0, 0.9, 3.25);
          sternumBody.rotation.x = 0.08;

          const manubrium = new THREE.Mesh(new THREE.CylinderGeometry(0.78, 0.62, 1.25, 18), matBone2);
          manubrium.position.set(0, 3.8, 3.25);

          const xiphoid = new THREE.Mesh(new THREE.ConeGeometry(0.35, 1.15, 18), matBone2);
          xiphoid.position.set(0, -2.0, 3.25);
          xiphoid.rotation.x = Math.PI;

          groups.sternum.add(sternumBody, manubrium, xiphoid);

          // Spine (schematic vertebral column)
          const spine = new THREE.Mesh(new THREE.CylinderGeometry(0.55, 0.65, 8.6, 20), matBone2);
          spine.position.set(0, 1.1, -3.25);

          // Diaphragm (dome)
          const diaphragm = new THREE.Mesh(
            new THREE.SphereGeometry(5.2, 36, 18, 0, Math.PI * 2, 0, Math.PI / 2),
            new THREE.MeshStandardMaterial({
              color: 0xA78BFA, roughness: 0.65, metalness: 0.02,
              transparent: true, opacity: 0.24,
              emissive: 0x2b145f, emissiveIntensity: 0.8
            })
          );
          diaphragm.position.set(0, -3.3, 0.4);
          diaphragm.scale.set(1.15, 0.55, 0.95);
          groups.diaphragm.add(diaphragm);

          // Superior aperture ring (highlight frame)
          const supRing = new THREE.Mesh(
            new THREE.TorusGeometry(4.95, 0.10, 12, 80),
            new THREE.MeshStandardMaterial({
              color: 0x38BDF8, roughness: 0.4, metalness: 0.05,
              transparent: true, opacity: 0.25,
              emissive: 0x1b4d66, emissiveIntensity: 1.0
            })
          );
          supRing.rotation.x = Math.PI / 2;
          supRing.position.set(0, 4.75, 0.2);
          groups.apertureSuperior.add(supRing);

          // Mediastinum volume
          const medi = new THREE.Mesh(new THREE.BoxGeometry(2.7, 5.8, 2.9), matMedi);
          medi.position.set(0, 1.0, 0.25);
          groups.mediastinum.add(medi);

          // Lungs (more ‚Äúreal‚Äù silhouette via distorted spheres)
          function makeLung(sideSign) {
            const geo = new THREE.SphereGeometry(2.7, 40, 28);
            // slight deformation to mimic lung contour (simple + stable)
            const pos = geo.attributes.position;
            for (let i = 0; i < pos.count; i++) {
              const x = pos.getX(i), y = pos.getY(i), z = pos.getZ(i);
              const taper = 1 - (y + 2.7) / 5.4; // taper toward base
              const bulge = 1 + 0.08 * Math.sin((y + 2.7) * 2.1) + 0.05 * Math.cos((z) * 2.4);
              pos.setXYZ(i, x * (1.0 + 0.08 * taper) * bulge, y * (1.15 - 0.1 * taper), z * (0.9 + 0.08 * taper));
            }
            geo.computeVertexNormals();

            const lung = new THREE.Mesh(geo, matLung);
            lung.position.set(2.7 * sideSign, 0.85, 1.1);
            lung.scale.set(1.05, 1.15, 0.95);
            return lung;
          }

          const lungL = makeLung(-1);
          const lungR = makeLung(+1);

          // Bronchi/vascular ‚Äúglow lines‚Äù inside lungs (procedural)
          function makeGlowNetwork(centerX) {
            const group = new THREE.Group();
            const paths = 14;
            for (let p = 0; p < paths; p++) {
              const pts = [];
              let x = centerX + (Math.random() - 0.5) * 0.4;
              let y = 1.2 + (Math.random() - 0.5) * 0.5;
              let z = 1.0 + (Math.random() - 0.5) * 0.5;

              pts.push(new THREE.Vector3(x, y, z));
              const steps = 9 + Math.floor(Math.random() * 6);
              for (let s = 0; s < steps; s++) {
                x += (Math.random() - 0.45) * 0.55;
                y += (Math.random() - 0.55) * 0.55;
                z += (Math.random() - 0.45) * 0.55;
                pts.push(new THREE.Vector3(x, y, z));
              }

              const g = new THREE.BufferGeometry().setFromPoints(pts);
              const line = new THREE.Line(g, matLine);
              line.material.opacity = 0.55 + Math.random() * 0.35;
              group.add(line);
            }
            return group;
          }

          const netL = makeGlowNetwork(-2.7);
          const netR = makeGlowNetwork(+2.7);

          // Particles (sparks)
          const particlesCount = 250;
          const pGeo = new THREE.BufferGeometry();
          const pPos = new Float32Array(particlesCount * 3);
          for (let i = 0; i < particlesCount; i++) {
            pPos[i*3+0] = (Math.random() - 0.5) * 18;
            pPos[i*3+1] = (Math.random() - 0.5) * 12;
            pPos[i*3+2] = (Math.random() - 0.5) * 16;
          }
          pGeo.setAttribute("position", new THREE.BufferAttribute(pPos, 3));
          const pMat = new THREE.PointsMaterial({ color: 0xFF5AAE, size: 0.06, transparent: true, opacity: 0.55 });
          const sparks = new THREE.Points(pGeo, pMat);

          // Assemble global
          groups.global.add(groups.ribs, groups.sternum, spine, groups.diaphragm, lungL, lungR, netL, netR, groups.apertureSuperior, groups.mediastinum, sparks);
          root.add(groups.global);

          // Default orientation
          root.rotation.x = -0.08;
          root.rotation.y = 0.55;

          // Controls
          let controls = null;
          if (interactive && window.THREE.OrbitControls) {
            controls = new THREE.OrbitControls(camera, canvasEl);
            controls.enableDamping = true;
            controls.dampingFactor = 0.06;
            controls.rotateSpeed = 0.6;
            controls.zoomSpeed = 0.7;
            controls.minDistance = 10;
            controls.maxDistance = 26;
          }

          // Resize helpers
          function resize() {
            const w = canvasEl.clientWidth || 1;
            const h = canvasEl.clientHeight || 1;
            const dpr = Math.min(window.devicePixelRatio || 1, 2);
            const need = canvasEl.width !== Math.floor(w * dpr) || canvasEl.height !== Math.floor(h * dpr);
            if (!need) return;
            renderer.setSize(w, h, false);
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            if (composer) composer.setSize(w, h);
          }

          const ro = new ResizeObserver(() => resize());
          ro.observe(canvasEl);

          // Focus highlighting
          let focusKey = "global";
          function setFocus(k) { focusKey = k || "global"; }

          function pulseMat(mat, t, base, amp, colorHex) {
            mat.emissive.setHex(colorHex);
            mat.emissiveIntensity = base + amp * (0.5 + 0.5 * Math.sin(t * 4.2));
          }

          function applyFocus(t) {
            // reset emissive baseline (cheap & stable)
            matBone.emissive.setHex(0x0b1b2e);  matBone.emissiveIntensity = 0.35;
            matBone2.emissive.setHex(0x0b1b2e); matBone2.emissiveIntensity = 0.25;
            matLung.emissive.setHex(0x3a001c);  matLung.emissiveIntensity = 0.55;
            matMedi.emissive.setHex(0x1a083a);  matMedi.emissiveIntensity = 0.7;

            // toggles
            groups.apertureSuperior.visible = (focusKey === "apertureSuperior" || focusKey === "global");
            groups.mediastinum.visible = (focusKey === "mediastinum" || focusKey === "global");

            // emphasize by focus
            if (focusKey === "ribs" || focusKey === "wall" || focusKey === "dimensions") {
              pulseMat(matBone, t, 0.55, 0.65, 0x38BDF8);
            } else if (focusKey === "sternum" || focusKey === "surface") {
              pulseMat(matBone2, t, 0.45, 0.7, 0x38BDF8);
            } else if (focusKey === "diaphragm") {
              const m = diaphragm.material;
              m.emissive.setHex(0x7C3AED);
              m.emissiveIntensity = 0.8 + 0.75 * (0.5 + 0.5 * Math.sin(t * 4.0));
            } else if (focusKey === "mediastinum") {
              pulseMat(matMedi, t, 0.85, 0.75, 0xA78BFA);
            } else if (focusKey === "apertureSuperior") {
              // ring already emissive; keep on + pulse slightly
              const m = supRing.material;
              m.emissiveIntensity = 0.9 + 0.7 * (0.5 + 0.5 * Math.sin(t * 4.0));
            } else {
              // global: gentle breathing motion
              const breathe = 1 + 0.01 * Math.sin(t * 2.0);
              lungL.scale.set(1.05*breathe, 1.15*breathe, 0.95*breathe);
              lungR.scale.set(1.05*breathe, 1.15*breathe, 0.95*breathe);
            }
          }

          // Render loop
          let raf = 0;
          function loop() {
            raf = requestAnimationFrame(loop);
            resize();

            const t = performance.now() / 1000;

            // Auto-rotate only if not interactive (card view)
            if (!interactive) root.rotation.y += 0.002;

            // Drift sparks slightly
            const pos = pGeo.attributes.position;
            for (let i = 0; i < pos.count; i++) {
              const ix = i*3;
              pPos[ix+1] += 0.002 * (0.5 + Math.sin(t + i)*0.5);
              if (pPos[ix+1] > 8) pPos[ix+1] = -8;
            }
            pos.needsUpdate = true;

            applyFocus(t);
            if (controls) controls.update();

            if (composer) composer.render();
            else renderer.render(scene, camera);
          }
          loop();

          function resetView() {
            root.rotation.x = -0.08;
            root.rotation.y = 0.55;
            if (controls) {
              controls.target.set(0, 1.0, 0.5);
              controls.update();
            }
          }

          function destroy() {
            cancelAnimationFrame(raf);
            ro.disconnect();
            try { renderer.dispose(); } catch(_) {}
          }

          return { setFocus, resetView, destroy };
        } catch (err) {
          if (noWebGLEl) noWebGLEl.classList.remove("hidden");
          return null;
        }
      }

      // Instances:
      const thoraxPreview = createNeonThorax3D(canvasPreview, noWebGLPreview, { interactive: true });
      const thoraxCard    = createNeonThorax3D(canvasCard, noWebGLCard, { interactive: false });
      let thoraxInspect   = null; // lazy

      btnPreviewReset.addEventListener("click", () => thoraxPreview?.resetView());

      // =========================
      // 8) Game flow
      // =========================
      function resetCardVisual() {
        card.classList.remove("swipe-left","swipe-right","shake");
        card.style.transform = "";
        card.style.setProperty("--dx","0px");
        card.style.setProperty("--rot","0deg");
        setStamp("nope", false);
        setStamp("like", false);
      }

      function updateFocus(focusKey) {
        state.currentFocus = focusKey || "global";
        tagFocus.textContent = `Focus : ${focusLabel(state.currentFocus)}`;
        thoraxCard?.setFocus(state.currentFocus);
        thoraxPreview?.setFocus(state.currentFocus);
        thoraxInspect?.setFocus(state.currentFocus);
      }

      function showQuestion() {
        resetCardVisual();
        hideFeedback();
        setLocked(false);

        const q = state.questions[state.index];
        statementEl.textContent = q.statement;

        updateFocus(q.focus);
        updateHUD();
        startTimer();
      }

      function startGame() {
        state.questions = QUESTIONS.slice();
        state.index = 0;
        state.score = 0;
        state.satisfaction = 50;
        state.locked = false;

        setVisible(startScreen, false);
        setVisible(endScreen, false);
        setVisible(gameScreen, true);

        updateHUD();
        showQuestion();
      }

      function endGame() {
        stopTimer();
        setLocked(true);

        setVisible(gameScreen, false);
        setVisible(endScreen, true);

        finalScore.textContent = String(state.score);
        finalSatisfaction.textContent = String(state.satisfaction);

        const m = mentionFromScore(state.score);
        finalMention.textContent = m.label;
        finalTip.textContent = m.tip;

        if (state.score >= 14) safeConfettiBurst();
      }

      function backToStart() {
        stopTimer();
        setVisible(gameScreen, false);
        setVisible(endScreen, false);
        setVisible(startScreen, true);
      }

      function nextQuestion() {
        resetCardVisual();
        hideFeedback();
        state.index += 1;
        if (state.index >= state.questions.length) endGame();
        else showQuestion();
      }

      function showFeedbackUI(isCorrect, qExplain, isTimeout) {
        if (isCorrect) {
          state.score += 1;
          state.satisfaction = clamp(state.satisfaction + 6, 0, 100);
          showFeedback(true, qExplain, false);
        } else {
          state.satisfaction = clamp(state.satisfaction - 8, 0, 100);
          showFeedback(false, qExplain, isTimeout);
          card.classList.add("shake");
        }
        updateHUD();
      }

      function animateSwipe(direction) {
        // direction: "like" or "nope"
        if (direction === "like") setStamp("like", true);
        else setStamp("nope", true);

        card.classList.add(direction === "like" ? "swipe-right" : "swipe-left");
      }

      function handleChoice(userLike, isTimeout) {
        if (state.locked) return;
        setLocked(true);
        stopTimer();

        const q = state.questions[state.index];
        const isCorrect = (userLike === q.correct);

        showFeedbackUI(isCorrect, q.explain, !!isTimeout);
        animateSwipe(userLike ? "like" : "nope");

        const delay = isCorrect ? 760 : 1200;
        window.setTimeout(nextQuestion, delay);
      }

      // =========================
      // 9) Tinder swipe (drag)
      // =========================
      const drag = { active:false, startX:0, startY:0, dx:0, dy:0 };
      const SWIPE_THRESHOLD = 120;

      function onPointerDown(e) {
        if (state.locked) return;
        drag.active = true;
        drag.startX = e.clientX;
        drag.startY = e.clientY;
        drag.dx = 0;
        drag.dy = 0;
        card.setPointerCapture?.(e.pointerId);
      }

      function onPointerMove(e) {
        if (!drag.active || state.locked) return;
        drag.dx = e.clientX - drag.startX;
        drag.dy = e.clientY - drag.startY;

        const rot = clamp(drag.dx / 18, -16, 16);
        const lift = clamp(Math.abs(drag.dx) / 600, 0, 0.03);
        card.style.setProperty("--dx", `${drag.dx}px`);
        card.style.setProperty("--rot", `${rot}deg`);
        card.style.transform = `translateX(${drag.dx}px) rotate(${rot}deg) scale(${1 - lift})`;

        // Stamp intensity
        const likeAlpha = clamp((drag.dx - 30) / 140, 0, 1);
        const nopeAlpha = clamp((-drag.dx - 30) / 140, 0, 1);

        stampLike.style.opacity = String(likeAlpha);
        stampNope.style.opacity = String(nopeAlpha);

        stampLike.classList.toggle("show", likeAlpha > 0.02);
        stampNope.classList.toggle("show", nopeAlpha > 0.02);

        // Stronger shadow while dragging
        card.style.boxShadow = `0 28px 90px rgba(0,0,0,.55), 0 8px 24px rgba(0,0,0,.35)`;
      }

      function resetDrag() {
        drag.active = false;
        resetCardVisual();
        stampLike.style.opacity = "";
        stampNope.style.opacity = "";
        card.style.boxShadow = "";
      }

      function onPointerUp() {
        if (!drag.active || state.locked) return;
        drag.active = false;

        // Decide swipe
        if (drag.dx > SWIPE_THRESHOLD) { handleChoice(true, false); return; }  // LIKE
        if (drag.dx < -SWIPE_THRESHOLD) { handleChoice(false, false); return; } // NOPE

        resetDrag();
      }

      card.addEventListener("pointerdown", onPointerDown);
      window.addEventListener("pointermove", onPointerMove);
      window.addEventListener("pointerup", onPointerUp);

      // Buttons
      btnNope.addEventListener("click", () => handleChoice(false, false));
      btnLike.addEventListener("click", () => handleChoice(true, false));

      btnStart.addEventListener("click", startGame);
      btnRestart.addEventListener("click", startGame);
      btnBackToStart.addEventListener("click", backToStart);

      // Keyboard
      window.addEventListener("keydown", (e) => {
        if (e.repeat) return;
        const inGame = !gameScreen.classList.contains("hidden");
        const inStart = !startScreen.classList.contains("hidden");

        if (inStart && e.key === "Enter") { startGame(); return; }

        if (inGame) {
          if (e.key === "ArrowLeft") { e.preventDefault(); handleChoice(false, false); }
          if (e.key === "ArrowRight") { e.preventDefault(); handleChoice(true, false); }
          if (e.key.toLowerCase() === "i") { e.preventDefault(); openInspect(); }
        }
      });

      // =========================
      // 10) Inspect Modal (interactive)
      // =========================
      function openInspect() {
        if (state.inspectOpen) return;
        state.inspectOpen = true;

        inspectModal.classList.remove("modalHidden");

        // Lazy init
        if (!thoraxInspect) {
          thoraxInspect = createNeonThorax3D(canvasInspect, noWebGLInspect, { interactive: true });
        }
        thoraxInspect?.setFocus(state.currentFocus);
      }

      function closeInspect() {
        state.inspectOpen = false;
        inspectModal.classList.add("modalHidden");
      }

      btnInspect3D.addEventListener("click", openInspect);
      btnInspectClose.addEventListener("click", closeInspect);
      btnInspectReset.addEventListener("click", () => thoraxInspect?.resetView());

      // Close modal by clicking backdrop
      inspectModal.addEventListener("click", (e) => {
        if (e.target === inspectModal) closeInspect();
      });

      // =========================
      // Init
      // =========================
      qTotalEl.textContent = String(QUESTIONS.length);
      updateFocus("global");

    })();
  </script>
</body>
</html>
